<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<title>Tiki Tour</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
  :root{
    --bg:#fff;
    --card:#f8f8f8;
    --text:#111;
    --muted:#666;
    --accent:#ff8833;
    --accent-2:#32c48d;
    --shadow: 0 8px 24px rgba(10,10,10,0.08);
    --glass: rgba(255,255,255,0.6);
  }
  @media (prefers-color-scheme: dark) {
    :root{
      --bg: #081018;
      --card: rgba(12,18,24,0.7);
      --text: #e9f5ef;
      --muted: #9fb3a6;
      --accent:#ffb06b;
      --accent-2:#4bedb3;
      --shadow: 0 10px 30px rgba(0,0,0,0.6);
      --glass: rgba(6,8,10,0.5);
    }
  }

  html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial; background: linear-gradient(180deg, rgba(255,241,224,0.3), transparent 40%), var(--bg); color:var(--text); -webkit-font-smoothing:antialiased;}
  @media (prefers-color-scheme: light) {
    body{background: linear-gradient(180deg, #fff8f0, #f7fbf9 60%), var(--bg);}
  }

  #splash {
    position:fixed; inset:0; z-index:9999; display:flex; align-items:center; justify-content:center;
    background: linear-gradient(135deg, rgba(3,91,70,0.95), rgba(19,53,57,0.95));
    color: white; flex-direction:column; gap:18px;
    -webkit-backdrop-filter: blur(6px); backdrop-filter: blur(6px);
  }
  .splash-title { font-size:28px; font-weight:800; letter-spacing:0.6px; display:flex; align-items:center; gap:12px; }
  .tiki {
    width:86px; height:86px; border-radius:18px; background:linear-gradient(180deg,#ffe1b9,#ffd59a); display:flex; align-items:center; justify-content:center;
    box-shadow: 0 12px 40px rgba(0,0,0,0.35); transform: rotate(-6deg);
  }
  .tiki-emoji { font-size:46px; transform: translateY(6px); }
  .coconut { width:46px; height:46px; border-radius:50%; border:4px solid rgba(255,255,255,0.12); display:flex; align-items:center; justify-content:center; animation: coconutSpin 1500ms linear infinite; }
  @keyframes coconutSpin { from { transform: rotate(0deg);} to { transform: rotate(360deg); } }

  #app { max-width:1000px; margin: 12vh auto 48px; padding: 12px; box-sizing:border-box; }
  .card { background: var(--card); border-radius: 14px; box-shadow: var(--shadow); overflow: hidden; -webkit-backdrop-filter: blur(6px); padding:0; }
  #map { width:100%; height:64vh; min-height:420px; display:block; border-radius:12px 12px 0 0; }

  .controls {
    display:flex; gap:10px; padding:14px; align-items:center; flex-wrap:wrap;
  }
  .input { display:flex; gap:8px; align-items:center; }
  label.small { font-size:13px; color:var(--muted); margin-right:6px; }
  input[type="number"], select {
    width:120px; padding:10px 12px; border-radius:10px; border:1px solid rgba(0,0,0,0.06);
    background: transparent; color:var(--text); font-size:15px; outline:none;
  }
  @media (prefers-color-scheme: dark) {
    input[type="number"], select { border:1px solid rgba(255,255,255,0.04); }
  }

  .btn {
    padding:10px 14px; font-weight:700; border-radius:12px; border:none; cursor:pointer; font-size:15px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    background: linear-gradient(180deg,var(--accent), color-mix(in srgb, var(--accent) 85%, black 8%));
    color: #062014;
    display:inline-flex; align-items:center; gap:8px;
    transition: transform 180ms ease, box-shadow 180ms ease;
  }
  .btn:active { transform: translateY(2px); box-shadow: 0 4px 12px rgba(0,0,0,0.12); }
  .btn.ghost { background:transparent; color:var(--text); border:1px solid rgba(0,0,0,0.06); }

  .meta { padding:12px 14px; color:var(--muted); font-size:14px; }
  .stats { padding: 8px 14px 18px 14px; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .pill { background: linear-gradient(90deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)); padding:8px 12px; border-radius:999px; font-weight:700; color:var(--text); }

  .mascot { position: fixed; right:14px; bottom:18vh; z-index:900; display:flex; align-items:center; gap:10px; pointer-events: none; }
  .monkey { font-size:38px; transform-origin:center; display:inline-block; animation: monkeyDance 1600ms ease-in-out infinite; filter: drop-shadow(0 8px 18px rgba(0,0,0,0.25)); }
  .mascot-bubble { background: var(--glass); padding:8px 10px; border-radius: 999px; font-weight:700; color:var(--text); font-size:14px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); pointer-events:none; }
  @keyframes monkeyDance {
    0% { transform: translateY(0) rotate(-6deg) scale(1); }
    25% { transform: translateY(-6px) rotate(6deg) scale(1.06); }
    50% { transform: translateY(0px) rotate(-4deg) scale(1); }
    75% { transform: translateY(-4px) rotate(8deg) scale(1.03); }
    100% { transform: translateY(0) rotate(-6deg) scale(1); }
  }
  .drop-pin { animation: dropPin 540ms cubic-bezier(.2,.9,.2,1) both; }
  @keyframes dropPin {
    0% { transform: translateY(-200px) scale(0.8); opacity:0; }
    60% { transform: translateY(16px) scale(1.05); opacity:1; }
    100% { transform: translateY(0) scale(1); }
  }
  .hidden { display:none; }
  @media (max-width:520px) {
    .controls { padding:12px; gap:8px; }
    #map { height:65vh; min-height:360px; }
    .mascot { right:10px; bottom:22vh; }
    body { margin-bottom:48px; }
  }
</style>
</head>
<body>

<div id="splash">
  <div class="tiki"><div class="tiki-emoji">üå∫</div></div>
  <div class="splash-title">
    <div style="display:flex;flex-direction:column;line-height:1">
      <div style="font-size:20px;font-weight:900">Tiki Tour</div>
      <div style="font-size:12px;opacity:0.95">Find a random road. Take a little adventure.</div>
    </div>
  </div>
  <div class="coconut center" style="margin-top:8px"><div style="font-size:20px">ü••</div></div>
</div>

<div id="app" class="card" style="max-width:880px;margin:auto">

  <div id="map"></div>

  <div class="controls">
    <div class="input">
      <label class="small" for="kmInput">Distance km</label>
      <input id="kmInput" type="number" step="0.1" min="0.1" value="5" />
    </div>

    <div class="input">
      <label class="small" for="tripType">Trip</label>
      <select id="tripType">
        <option value="oneway">One Way</option>
        <option value="return">Return Trip</option>
      </select>
    </div>

    <div class="input">
      <label class="small" for="timeLimit">Max Time (min)</label>
      <input id="timeLimit" type="number" step="1" min="5" value="120" />
    </div>

    <div class="input">
      <label class="small" for="mapApp">Open with</label>
      <select id="mapApp">
        <option value="apple">Apple Maps</option>
        <option value="google">Google Maps</option>
        <option value="waze">Waze</option>
      </select>
    </div>

    <button id="pickBtn" class="btn">üéØ Pick Random Road</button>
    <button id="openMapsBtn" class="btn ghost" disabled>üß≠ Open</button>
    <button id="clearBtn" class="btn ghost">üßπ Clear</button>

    <div id="status" style="margin-left:auto;color:var(--muted);font-size:14px">Waiting for location.</div>
  </div>

  <div class="stats">
    <div id="routeInfo" class="pill">No route selected</div>
    <div style="color:var(--muted);font-size:13px">Add to Home Screen for app-like feel.</div>
  </div>

</div>

<div class="mascot" aria-hidden="true">
  <div class="mascot-bubble">Ready for a Tiki hop?</div>
  <div class="monkey" id="monkeyEmoji">üêí</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const splash = document.getElementById('splash');
const statusEl = document.getElementById('status');
const kmInput = document.getElementById('kmInput');
const pickBtn = document.getElementById('pickBtn');
const openMapsBtn = document.getElementById('openMapsBtn');
const clearBtn = document.getElementById('clearBtn');
const routeInfo = document.getElementById('routeInfo');
const monkey = document.getElementById('monkeyEmoji');
const mapAppSelect = document.getElementById('mapApp');
const tripTypeSelect = document.getElementById('tripType');
const timeLimitInput = document.getElementById('timeLimit');

let userCoords = null, userMarker = null, destMarker = null, routeLayer = null, snappedDest = null;

// map
const map = L.map('map').setView([0,0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'¬© OpenStreetMap'}).addTo(map);

// location
function hideSplash(){splash.style.opacity='0';splash.style.transform='scale(0.98)';setTimeout(()=>splash.remove(),520);}
function setStatus(t){statusEl.textContent=t||'';}
function enableLocation(){
  if(!navigator.geolocation){setStatus('Location not supported.');return;}
  setStatus('Locating you.');
  navigator.geolocation.getCurrentPosition(pos=>{
    userCoords={lat:pos.coords.latitude,lon:pos.coords.longitude};
    setStatus('');
    if(userMarker)userMarker.remove();
    userMarker=L.marker([userCoords.lat,userCoords.lon],{title:'You'}).addTo(map);
    map.setView([userCoords.lat,userCoords.lon],13);
    hideSplash();
  },()=>setStatus('Allow location in browser.'),{enableHighAccuracy:true});
}
enableLocation();

// helpers
const NORTH_ISLAND_BOUNDS={minLat:-41.6,maxLat:-34.3};
function isSameIsland(lat1,lat2){return (lat1>NORTH_ISLAND_BOUNDS.minLat && lat2>NORTH_ISLAND_BOUNDS.minLat)||(lat1<NORTH_ISLAND_BOUNDS.minLat && lat2<NORTH_ISLAND_BOUNDS.minLat);}
function mapsUrl(app,from,to){
  if(app==='google')return`https://www.google.com/maps/dir/?api=1&origin=${from.lat},${from.lon}&destination=${to.lat},${to.lon}&travelmode=driving`;
  if(app==='waze')return`https://waze.com/ul?ll=${to.lat},${to.lon}&navigate=yes`;
  return`https://maps.apple.com/?saddr=${from.lat},${from.lon}&daddr=${to.lat},${to.lon}&dirflg=d`;
}
function randomCoordinate(clat,clon,maxM){
  const R=6371000,r=Math.sqrt(Math.random())*maxM,bear=Math.random()*2*Math.PI;
  const lat1=clat*Math.PI/180,lon1=clon*Math.PI/180;
  const lat2=Math.asin(Math.sin(lat1)*Math.cos(r/R)+Math.cos(lat1)*Math.sin(r/R)*Math.cos(bear));
  const lon2=lon1+Math.atan2(Math.sin(bear)*Math.sin(r/R)*Math.cos(lat1),Math.cos(r/R)-Math.sin(lat1)*Math.sin(lat2));
  return{lat:lat2*180/Math.PI,lon:lon2*180/Math.PI};
}
async function snapToRoad(lon,lat){
  try{
    const r=await fetch(`https://router.project-osrm.org/nearest/v1/driving/${lon},${lat}?number=1`);
    const j=await r.json();if(j.waypoints&&j.waypoints[0]){const w=j.waypoints[0];return{lat:w.location[1],lon:w.location[0]};}
  }catch(e){console.error(e);}return null;
}
async function getRoute(u,d){
  try{
    const r=await fetch(`https://router.project-osrm.org/route/v1/driving/${u.lon},${u.lat};${d.lon},${d.lat}?overview=full&geometries=geojson`);
    const j=await r.json();if(j.routes&&j.routes[0])return j.routes[0];
  }catch(e){console.error(e);}return null;
}

function showRoute(route,snapped){
  if(destMarker)destMarker.remove();if(routeLayer)routeLayer.remove();
  destMarker=L.marker([snapped.lat,snapped.lon],{title:'Destination'}).addTo(map);
  destMarker._icon.classList.add('drop-pin');
  const coords=route.geometry.coordinates.map(c=>[c[1],c[0]]);
  routeLayer=L.polyline(coords,{color:'#ff8833',weight:5,opacity:0.95}).addTo(map);
  map.fitBounds([[userCoords.lat,userCoords.lon],[snapped.lat,snapped.lon]].map(c=>L.latLng(c)),{padding:[50,50]});
  const distKm=(route.distance/1000).toFixed(2);
  const mins=Math.round(route.duration/60);
  const type=tripTypeSelect.value;
  const totalKm=type==='return'?(distKm*2).toFixed(2):distKm;
  const totalMins=type==='return'?mins*2:mins;
  routeInfo.textContent=`${type==='return'?'Return trip':'One way'}: ${totalKm} km, approx ${totalMins} min`;
}

pickBtn.addEventListener('click',async()=>{
  if(!userCoords){setStatus('Waiting for location.');return;}
  pickBtn.disabled=true;openMapsBtn.disabled=true;setStatus('Searching...');routeInfo.textContent='Searching...';
  const km=Math.max(0.1,parseFloat(kmInput.value)||5);
  const maxMeters=km*1000;
  let foundRoute=null,foundSnapped=null;
  for(let i=0;i<14;i++){
    const cand=randomCoordinate(userCoords.lat,userCoords.lon,maxMeters);
    const snapped=await snapToRoad(cand.lon,cand.lat);
    if(!snapped)continue;
    if(!isSameIsland(userCoords.lat,snapped.lat))continue;
    const route=await getRoute(userCoords,snapped);
    if(!route)continue;
    let totalDist=route.distance,totalTime=route.duration;
    if(tripTypeSelect.value==='return'){totalDist*=2;totalTime*=2;}
    if(totalTime>parseFloat(timeLimitInput.value)*60)continue;
    foundRoute=route;foundSnapped=snapped;break;
  }
  if(foundRoute&&foundSnapped){
    showRoute(foundRoute,foundSnapped);
    snappedDest=foundSnapped;
    setStatus('Ready!');
    openMapsBtn.disabled=false;
  } else {
    routeInfo.textContent='No valid route found. Try longer distance or time.';
    setStatus('Try again.');
  }
  pickBtn.disabled=false;
});

openMapsBtn.addEventListener('click',()=>{
  if(!snappedDest)return;
  window.open(mapsUrl(mapAppSelect.value,userCoords,snappedDest),'_blank');
});

clearBtn.addEventListener('click',()=>{
  if(destMarker)destMarker.remove();if(routeLayer)routeLayer.remove();
  routeInfo.textContent='No route selected';setStatus('');
  openMapsBtn.disabled=true;
});

setTimeout(()=>hideSplash(),5000);
</script>

</body>
</html>
